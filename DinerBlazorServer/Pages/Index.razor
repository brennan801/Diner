@page "/"
@using JCsDiner
@using Services
@inject SimulationHostedService SimService

<PageTitle>Index</PageTitle>

<div class="row">

    <div class="col-6">
        <label for="name">Simulation Name:</label>
        <input @bind=simName  type="text" min="1" placeholder="Simulation Name" required />
        <br />

        <label for="parties">Number of Parties:</label>
        <input @bind=parties name="parties" type="number" min="1" max="999" required />
        <br />

        <label for="waiters">Number of Waiters:</label>
        <input @bind=waiters name="waiters" type="number" min="1" max="99" required />
        <br />

        <label for="cooks">Number of Cooks:</label>
        <input @bind=cooks name="cooks" type="number" min="1" max="99" required/>
        <br />

        <label for="tables">Number of Tables:</label>
        <input @bind=tables name="tables" type="number" min="3" max="99" required />
        <br />

        <label for="partySize">Average Party Size:</label>
        <input @bind=partySize name="partySize" type="number" min="1" max="13" required />
        <br />

        <label for="entryTime">Average Party Entry Time:</label>
        <input @bind=entryTime name="entryTime" type="range" min="1" max="10"/>
        <br />

        <label for="eatingTime">Average Party Eat Time:</label>
        <input @bind=eatingTime name="eatingTime" type="range" min="4" max="14"/>
        <br />

        <button @onclick="simulate">Simulate</button>
    </div>
    <div class="col-2">
        <h3>Host</h3>
        <p>Host: @sim.HostPCQ.HostModel.State @if (sim.HostPCQ.HostModel.State == HostModel.States.SeatingParty) {<p>Party: @sim.HostPCQ.HostModel.PartyID</p> }</p>
        <h3>Waiters</h3>
        @foreach(WaiterModel waiter in sim.WaiterPCQ.WaiterModels)
        {
            <p>Waiter @waiter.ID: @waiter.State @if (waiter.State != WaiterModel.States.Free) { <p>Table: @waiter.PartyID</p> }</p>
        }
    </div>
    <div class="col-2">
        <h3>Current Parties</h3>
        @foreach(Party party in sim.Restaurant.CurrentParties)
        {
            <p>Party @party.ID: State - @party.State.Value , Size - @party.Customers</p>
        }
    </div>
    <div class="col-2">
        <h3>Cooks</h3>
        @foreach(CookModel cook in sim.CookPCQ.Cooks)
        {
            <p>Cook @cook.ID: @cook.State @if (cook.State == CookModel.States.Cooking) { <p>Order: @cook.OrderID</p> }</p>
        }
    </div>
</div>



<h3>Results:</h3>
<p>Simulation: @simResults.Name</p>
<p>Run Time: @simResults.Runtime</p>
<p>parties: @simResults.NumberOfCustomers</p>
<p>waiters: @simResults.NumberOfWaiters</p>
<p>cooks: @simResults.NumberOfCooks</p>
<p>tables: @simResults.NumberOfTables</p>
<p>avg party size: @simResults.ActualAveragePartySize</p>
<p>avg entry time: @simResults.AverageEntryTime</p>

@code{
    Simulator sim = new();
    string simName = "Simulation Name";
    int parties = 10;
    int waiters = 2;
    int cooks = 2;
    int tables = 6;
    int partySize = 4;
    int entryTime = 4;
    int eatingTime = 6;
    string result = "";
    SimulatorResults simResults = new();
    System.Threading.CancellationToken cancellationToken = new();

    private void Simulator_StateChanged(object? sender, EventArgs e)
    {
        InvokeAsync(() => StateHasChanged());
    }

    async Task simulate()
    {
        sim = SimService.Simulator;
        SimService.StateChanged += Simulator_StateChanged;
        SimulatorArguments simArgs = new()
        {
            Customers = parties,
            NumberOfWaiters = waiters,
            NumberOfCooks = cooks,
            NumberOfTables = tables,
            AveragePartySize = partySize,
            AveragePartyEntryTime = entryTime,
            AverageEatingTime = eatingTime
        };
        SimService.Arguments = simArgs;
        SimService.CanStart = true;
        try
        {
            System.Console.WriteLine("about to start");
            await SimService.StartAsync(cancellationToken);
            simResults = SimService.Results;
            System.Console.WriteLine("passed await");
        }
        catch(Exception e)
        {
            throw;
        }
        finally
        {
            System.Console.WriteLine("Finally");
        }
        System.Console.WriteLine("we got here!");
    }
}
